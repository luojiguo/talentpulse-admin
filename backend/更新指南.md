# 后端路由更新指南

## 概述
为了统一错误处理和数据库查询超时，需要对所有路由文件进行更新。

## 更新步骤

### 1. 更新导入语句
在每个路由文件的开头，将：
```javascript
const { pool } = require('../config/db');
```
改为：
```javascript
const { pool, query } = require('../config/db');
const { asyncHandler } = require('../middleware/errorHandler');
```

### 2. 使用统一的query函数
将所有 `pool.query()` 调用改为 `query()`，例如：
```javascript
// 旧代码
const result = await pool.query('SELECT * FROM users WHERE id = $1', [id]);

// 新代码
const result = await query('SELECT * FROM users WHERE id = $1', [id]);
```

### 3. 使用asyncHandler包装异步路由
将所有异步路由处理函数用 `asyncHandler` 包装，例如：
```javascript
// 旧代码
router.get('/:id', async (req, res) => {
  try {
    // ...
  } catch (error) {
    res.status(500).json({ status: 'error', message: error.message });
  }
});

// 新代码
router.get('/:id', asyncHandler(async (req, res) => {
  // ... 代码，错误会自动被错误处理中间件捕获
}));
```

### 4. 使用错误对象而非直接返回响应
在路由处理函数中，使用错误对象抛出错误，而不是直接返回响应：
```javascript
// 旧代码
if (!user) {
  return res.status(404).json({ status: 'error', message: '用户不存在' });
}

// 新代码
if (!user) {
  const error = new Error('用户不存在');
  error.statusCode = 404;
  error.errorCode = 'USER_NOT_FOUND';
  throw error;
}
```

## 已更新的文件
- ✅ `userRoutes.js` - 已更新登录和注册路由
- ✅ `messageRoutes.js` - 已更新对话列表路由
- ⏳ 其他路由文件需要按上述步骤更新

## 注意事项
1. `pool` 仍然可以用于需要事务的场景（如 `pool.connect()`）
2. `query` 函数会自动处理超时错误
3. 使用 `asyncHandler` 后，不需要手动 try-catch，错误会自动被统一处理中间件捕获

